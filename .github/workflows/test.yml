name: CI

on:
  pull_request:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: ubuntu-22.04
            type: native
            cc: clang
            cxx: clang++
            shell: sh

    defaults:
      run:
        shell: ${{ matrix.platform.shell }}

    runs-on: ${{ matrix.platform.os }}
    env:
      CC: ${{ matrix.platform.cc }}
      CXX: ${{ matrix.platform.cxx }}
    steps:
      - run: mkdir -p build/out && echo "foo" > build/out/CHECKSUMS.txt
      - run: |
          echo "$GPG_KEY_PRIVATE" | gpg --batch --import
          gpg --list-keys
          set -x
          gpg --batch --yes --pinentry-mode loopback --trust-model always \
            --passphrase "$GPG_KEY_PASS" --local-user "$GPG_KEY_FINGERPRINT" \
            --output build/out/CHECKSUMS.txt.sig --detach-sign build/out/CHECKSUMS.txt
          tree build/out
          gpg --batch --yes --delete-secret-keys "9C6328B7F7D5AA04"
          gpg --batch --yes --delete-keys "9C6328B7F7D5AA04"
          curl --silent --show-error --location 'https://www.sourcemeta.com/gpg.asc' | gpg --import
          gpg --verify build/out/CHECKSUMS.txt.sig build/out/CHECKSUMS.txt
        env:
          GPG_KEY_PRIVATE: ${{ secrets.GPG_KEY_PRIVATE }}
          GPG_KEY_PASS: ${{ secrets.GPG_KEY_PASS }}
          GPG_KEY_FINGERPRINT: F1CCCE7BD9D52CB76FE05C9B9C6328B7F7D5AA04
