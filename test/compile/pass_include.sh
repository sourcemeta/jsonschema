#!/bin/sh

set -o errexit
set -o nounset

TMP="$(mktemp -d)"
clean() { rm -rf "$TMP"; }
trap clean EXIT

cat << 'EOF' > "$TMP/schema.json"
{
  "$id": "https://example.com",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "string"
}
EOF

"$1" compile "$TMP/schema.json" --include TEST_SCHEMA > "$TMP/output.h"

cat << 'EOF' > "$TMP/expected.h"
#ifndef SOURCEMETA_JSONSCHEMA_INCLUDE_TEST_SCHEMA_H_
#define SOURCEMETA_JSONSCHEMA_INCLUDE_TEST_SCHEMA_H_

#ifdef __cplusplus
#include <cstddef>
#include <string_view>
#endif

static const char TEST_SCHEMA_DATA[] = {
  0x5b, 0x66, 0x61, 0x6c, 0x73, 0x65, 0x2c, 0x74, 0x72, 0x75, 0x65, 0x2c,
  0x5b, 0x22, 0x22, 0x2c, 0x22, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f,
  0x2f, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x63, 0x6f, 0x6d,
  0x22, 0x5d, 0x2c, 0x5b, 0x5b, 0x5b, 0x31, 0x31, 0x2c, 0x22, 0x2f, 0x74,
  0x79, 0x70, 0x65, 0x22, 0x2c, 0x22, 0x22, 0x2c, 0x22, 0x23, 0x2f, 0x74,
  0x79, 0x70, 0x65, 0x22, 0x2c, 0x32, 0x2c, 0x5b, 0x38, 0x2c, 0x34, 0x5d,
  0x5d, 0x5d, 0x5d, 0x2c, 0x5b, 0x5d, 0x5d, 0x00
};

static const unsigned int TEST_SCHEMA_LENGTH = 79;

#ifdef __cplusplus
static constexpr std::string_view TEST_SCHEMA{TEST_SCHEMA_DATA, TEST_SCHEMA_LENGTH};
#endif

#endif
EOF

diff "$TMP/output.h" "$TMP/expected.h"

# Verify the header compiles with a C compiler
cat << 'EOF' > "$TMP/test.c"
#include "output.h"
EOF
cc -c "$TMP/test.c" -o "$TMP/test.o"

# Verify the header compiles with a C++ compiler
cat << 'EOF' > "$TMP/test.cc"
#include "output.h"
EOF
c++ -std=c++17 -c "$TMP/test.cc" -o "$TMP/test_cpp.o"
